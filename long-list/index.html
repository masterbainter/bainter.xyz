<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#3b82f6"/>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Checklist">
    <meta name="application-name" content="Checklist">
    
    <title>Trevor's Checklist</title>
    
    <!-- Link to Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- PWA Icons -->
    <link rel="apple-touch-icon" href="https://placehold.co/192x192/3b82f6/ffffff?text=CL">
    <link rel="icon" type="image/png" sizes="192x192" href="https://placehold.co/192x192/3b82f6/ffffff?text=CL">
    <link rel="icon" type="image/png" sizes="512x512" href="https://placehold.co/512x512/3b82f6/ffffff?text=CL">

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .task-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        .task-card.completed {
            background-color: #f3f4f6; /* gray-100 */
            opacity: 0.7;
        }
        .dark .task-card.completed {
             background-color: #374151; /* gray-700 */
             opacity: 0.5;
        }
        .task-card.completed .task-content {
            text-decoration: line-through;
            color: #6b7280; /* gray-500 */
        }
        .dark .task-card.completed .task-content {
            color: #9ca3af; /* gray-400 */
        }
        .priority-1 { border-left-color: #ef4444; } /* red-500 */
        .priority-2 { border-left-color: #f97316; } /* orange-500 */
        .priority-3 { border-left-color: #3b82f6; } /* blue-500 */
        .priority-4 { border-left-color: #84cc16; } /* lime-500 */

        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        .dark ::-webkit-scrollbar-track {
            background: #2d3748; /* gray-800 */
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        
        /* Modal styles */
        .modal-backdrop {
            background-color: rgba(0,0,0,0.5);
            transition: opacity 0.3s ease;
        }
        .modal-content {
            transition: transform 0.3s ease;
        }
    </style>
    <script>
      // Apply theme on initial load to avoid Flash of Unstyled Content (FOUC)
      if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
        document.documentElement.classList.add('dark');
      } else {
        document.documentElement.classList.remove('dark');
      }
    </script>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-800 dark:text-gray-200 transition-colors duration-300">

    <!-- Main Container -->
    <div id="app" class="container mx-auto p-4 md:p-8 max-w-7xl">
        
        <!-- Header -->
        <header class="flex flex-col md:flex-row justify-between items-center mb-6">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800 dark:text-gray-100 mb-4 md:mb-0">
                <i class="fas fa-check-double text-blue-500"></i> Trevor's Checklist
            </h1>
            <div class="flex items-center gap-2 md:gap-4">
                 <button id="theme-toggle" type="button" class="text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none focus:ring-4 focus:ring-gray-200 dark:focus:ring-gray-700 rounded-lg text-sm p-2.5">
                    <svg id="theme-toggle-dark-icon" class="hidden w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg>
                    <svg id="theme-toggle-light-icon" class="hidden w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.121-3.536a1 1 0 011.414 0l.707.707a1 1 0 01-1.414 1.414l-.707-.707a1 1 0 010-1.414zM4.05 16.95a1 1 0 010-1.414l.707-.707a1 1 0 011.414 1.414l-.707.707a1 1 0 01-1.414 0zM10 18a1 1 0 01-1-1v-1a1 1 0 112 0v1a1 1 0 01-1 1zM3.05 4.95a1 1 0 010 1.414l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 0zM16.95 4.05a1 1 0 011.414 0l.707.707a1 1 0 01-1.414 1.414l-.707-.707a1 1 0 010-1.414zM2 10a1 1 0 01-1-1V9a1 1 0 112 0v1a1 1 0 01-1 1z"></path></svg>
                </button>
                <button id="addTaskBtn" class="w-full md:w-auto bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">
                    <i class="fas fa-plus mr-2"></i>Add New Task
                </button>
            </div>
        </header>

        <!-- Loading / Initial State -->
        <div id="loading" class="text-center py-10">
            <p class="text-gray-500 dark:text-gray-400">Loading tasks...</p>
        </div>
        
        <!-- Controls -->
        <div id="controls" class="hidden mb-6 flex flex-col md:flex-row gap-4 items-center">
            <div class="relative flex-grow w-full">
                <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">
                    <i class="fas fa-search"></i>
                </span>
                <input type="text" id="searchInput" placeholder="Search tasks..." class="w-full pl-10 pr-4 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div class="flex gap-4 w-full md:w-auto">
                <select id="sortSelect" class="w-full md:w-auto bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-gray-200 rounded-lg py-2 px-4 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="priority">Sort by Priority</option>
                    <option value="content-asc">Sort by Name (A-Z)</option>
                    <option value="content-desc">Sort by Name (Z-A)</option>
                </select>
                <select id="filterSelect" class="w-full md:w-auto bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-gray-200 rounded-lg py-2 px-4 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="all">All Categories</option>
                    <option value="task">Tasks</option>
                    <option value="project">Projects</option>
                </select>
                 <select id="subCategoryFilter" class="w-full md:w-auto bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-gray-200 rounded-lg py-2 px-4 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="all">All Levels</option>
                    <option value="mini">Mini</option>
                    <option value="standard">Standard</option>
                    <option value="major">Major</option>
                </select>
            </div>
        </div>

        <!-- Task List -->
        <main id="taskList" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Task cards will be injected here -->
        </main>

    </div>

    <!-- Add/Edit Task Modal -->
    <div id="taskModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
        <div class="modal-backdrop fixed inset-0"></div>
        <div class="modal-content bg-white dark:bg-gray-800 rounded-lg shadow-2xl w-full max-w-md mx-auto z-10 transform scale-95">
            <form id="taskForm" class="p-6">
                <h2 id="modalTitle" class="text-2xl font-bold mb-6 text-gray-900 dark:text-white">Add New Task</h2>
                <input type="hidden" id="taskId">
                
                <div class="mb-4">
                    <label for="content" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Task Description</label>
                    <input type="text" id="content" class="w-full p-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>

                <div class="grid grid-cols-2 gap-4 mb-4">
                     <div>
                        <label for="category" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Category</label>
                        <select id="category" class="w-full p-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                            <option value="task">Task</option>
                            <option value="project">Project</option>
                        </select>
                    </div>
                    <div>
                        <label for="subCategory" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Level</label>
                        <select id="subCategory" class="w-full p-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                            <option value="mini">Mini</option>
                            <option value="standard">Standard</option>
                            <option value="major">Major</option>
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="priority" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Priority</label>
                        <select id="priority" class="w-full p-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                            <option value="1">1 (Highest)</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4 (Lowest)</option>
                        </select>
                    </div>
                     <div>
                        <label for="duration" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Duration</label>
                        <input type="number" id="duration" class="w-full p-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                </div>
                 <div class="mb-4">
                    <label for="durationUnit" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Duration Unit</label>
                    <select id="durationUnit" class="w-full p-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        <option value="minute">Minute(s)</option>
                        <option value="hour">Hour(s)</option>
                        <option value="day">Day(s)</option>
                    </select>
                </div>

                <div class="mb-6">
                    <label for="comment" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Comment / Cost</label>
                    <input type="text" id="comment" class="w-full p-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>

                <div class="flex justify-end gap-4">
                    <button type="button" id="cancelBtn" class="bg-gray-300 dark:bg-gray-600 hover:bg-gray-400 dark:hover:bg-gray-500 text-gray-800 dark:text-gray-200 font-bold py-2 px-4 rounded-lg transition-colors">Cancel</button>
                    <button type="submit" id="saveBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">Save Task</button>
                </div>
            </form>
        </div>
    </div>
    
    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, writeBatch, deleteDoc, updateDoc, onSnapshot, getDocs, enableIndexedDbPersistence, CACHE_SIZE_UNLIMITED } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- PWA Service Worker Registration ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(registration => {
                        console.log('ServiceWorker registration successful with scope: ', registration.scope);
                    })
                    .catch(err => {
                        console.log('ServiceWorker registration failed: ', err);
                    });
            });
        }

        // --- INITIAL DATA & PARSER ---
        const rawData = `
        TYPE Desc.TYPECategoryCONTENTPRIORITYRESPONSIBLEDATEDURATIONDURATION_UNITMoney?Comment
        standardtaskGet chainsaw running1Trevor1hour
        standardprojectMaddox Honda 50 rebuild engine2Trevor1day
        majortask#figure out suv running boards @4Trevor4hour
        standardtaskCreate tv policies at home4Trevor1hour
        standardtaskSwitch out battery connector new suv2Trevor1hour
        majortaskDrain liquid from dirt bikes3Trevor6hour
        standardtaskFixup and/or Move old washer out of Freezer room4Trevor1hour
        miniprojectSkirt the house2Trevor6hour
        standardprojectGarage Door Opener Fix Electricity (rain/wet issue)2Trevor8hour
        miniprojectBuild Bike Holder System in Garage/Quonset (4 bikes desire, 6 if possible)4Trevor6hour
        majortaskFishing gear: organize and clean4Trevor4hour
        standardtaskSakurs motorcycle: oil change4Trevor2hour
        standardtaskMaddox motorcycle: oil change4Trevor2hour
        majortaskTry to Repair 18V dewalt batteries4Trevor3hour
        miniprojectLiving to Porch Window Decide what to do4Trevor45minutestandardtaskFigure out home firewall issue4Trevor1hour
        miniprojectTry to adjust seal or fix it on quonet big doors4Trevor8hour
        standardtaskResearch/buy vapor barrier for attic insulation4Trevor1hour
        miniprojectRoll out insulation in attic and above kitchen2Trevor6hour
        standardtaskGet Bolt Title to Barry1Trevor1hour
        majorprojectBuild a Sauna Project4Trevor4day
        miniprojectFigure out if Bird Plucker Motor will work.1Trevor6hour
        majortaskType up training program for Sakura and Maddox2Trevor3hour
        minitaskPut old batteries in bolt1Trevor15minute
        standardtaskFind/Repair leak in living room window1Trevor3hour
        miniprojectFigure out Gutters1Trevor1day
        majorprojectSell YZ1253Trevor4day
        majortaskFix Gray Impala Power Steering Pump2Trevor4hour
        standardprojectReplace Bedroom Window3Trevor2day
        majorprojectDining room Hutch remodel (to wall where wood stove can be)4Trevor15day
        majorprojectBasement Poles (get metals ones to raise the floor a bit in spots)2Trevor2day
        StandardprojectRoof (Shingles have blown up againâ€¦)1Trevor3day
        stanadrdtaskShelf in basement (more storage / canning)4Trevor1hour
        miniprojectGo through basement Storage3Trevor5hour
        standardtaskGet Trevor Clothes out of Laundry Room3Trevor1hour
        miniprojectSet up DNS server virtualized so we can use that locally3Trevor4hour
        standardtaskFigure out Sakura's flip laptop (the screen flips over and works4Trevor1hour
        standardtaskHave chatGPT help me with my LinkedIn profile2Trevor2hour
        miniprojectFigure out a Central repository for all the phone pictures and backups2Trevor6hour
        majortaskBuild a process for creating characters so Iyoko can do it2Trevor3hour
        miniprojectGray as SUV starting issue electrical3Trevor6hour
        miniprojectResearch/Setup something like quote IQ for mowing.day4Trevor3hour
        majortaskFlow Chart mowing.day setups so far3Trevor3hour
        standardtaskDefine Funnels for mowing.day past/future4Trevor2hour
        standardtaskAOW Exhibition during duals idea1Trevor2hour
        MajortaskDishWasher not Draining Troubleshooting1Trevor4hour
        MajortaskFinish acquiring electrical fencing strand4Trevor3hour
        standardtaskMake kettlebell holder4Trevor2hour
        miniprojectFix Up Boat (make water ready) 3Trevor1day
        standardprojectTrailer build 3Trevor2day
        MajortaskFix Potholes in Driveway2Trevor4hour
        StandardtaskFix Kitchen Door Bottom Hing (holes worn out)2Trevor 2hour
        MajortaskFix Red Truck Hitch4Trevor 6hour
        MajorProjectBuildout IT Work Scheduling app4Trevor 4dayUsing what I learned from mowing.day about bonnecting bookings app with web app. Possibly a way to align schedule with traveling for either wrestling or whatever and pick up IT Jobs that I can solve in 1-4 hours work for extra money
        majortaskReview/update Tasking/Project workflow2Trevor 6hour
        majorprojectBuild a butcher room in quonset4Trevor 6day$$$$$
        majortaskRed Truck: Fix Brakes (inspect and fix)4Trevor 1day$$
        majortaskBuild out kids productivity game (school/Todo/chores/etc.)2Trevor 6hour$
        standardprojectFix SUV Sunroof 4Trevor 2day$$
        majortaskSet up DNS redudnancy at home4Trevor 4hour
        majortaskShower plumbing (sometimes bad smells) troubleshootin / fix3Trevor 6hour$$$
        miniprojectSakura Education 5th grade plan buildout2Trevor 1day$
        miniprojectMaddox Education 4th grade plan buildout2Trevor 1day$
        miniprojectSakura Athletic Program Buildout2Trevor 1day$
        miniprojectMaddox Athletic Program Buildout2Trevor 1day$
        `;
        
        function parseInitialData(text) {
            const tasks = [];
            const typeKeywords = ['standardtask', 'standardproject', 'majortask', 'majorproject', 'miniproject', 'minitask', 'stanadrdtask', 'Standardproject', 'Majortask', 'MajorProject'];
            const splitRegex = new RegExp(`(${typeKeywords.join('|')})`, 'gi');
            const correctedText = text.replace(splitRegex, '\n$1').trim();
            const lines = correctedText.split('\n').filter(line => line.trim() !== '' && !line.toLowerCase().includes('type desc'));

            for (const line of lines) {
                const foundType = typeKeywords.find(t => line.toLowerCase().startsWith(t.toLowerCase()));
                if (!foundType) continue;

                const restOfLine = line.substring(foundType.length);
                const match = restOfLine.match(/(.+?)(\d)\s*(Trevor)\s*(\d+)\s*([a-zA-Z]+)(.*)/);
                
                if (match) {
                    const normalizedType = foundType.toLowerCase().replace('stanadrdtask', 'standardtask');
                    const category = normalizedType.includes('project') ? 'project' : 'task';
                    const subCategory = normalizedType.replace('project', '').replace('task', '');

                    tasks.push({
                        category,
                        subCategory,
                        content: match[1].replace(/^:/, '').trim(),
                        priority: parseInt(match[2], 10),
                        responsible: match[3],
                        duration: parseInt(match[4], 10),
                        durationUnit: match[5].replace(/s$/, '').toLowerCase(),
                        comment: match[6].trim(),
                        completed: false,
                        createdAt: new Date()
                    });
                }
            }
            return tasks;
        }

        // --- FIREBASE SETUP ---
        const firebaseConfig = {
            apiKey: "AIzaSyD4siULVs184mF6tkcuTRzybRPGxApu5TQ",
            authDomain: "bainter-xyz.firebaseapp.com",
            projectId: "bainter-xyz",
            storageBucket: "bainter-xyz.appspot.com",
            messagingSenderId: "754582576816",
            appId: "1:754582576816:web:6c2c2c5c0dd774f8122575",
            measurementId: "G-03560RG2S2"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- ENABLE OFFLINE PERSISTENCE ---
        enableIndexedDbPersistence(db)
            .catch((err) => {
                if (err.code == 'failed-precondition') {
                    console.warn('Persistence failed: multiple tabs open.');
                } else if (err.code == 'unimplemented') {
                    console.warn('Persistence failed: browser does not support it.');
                }
            });

        
        let userId;
        let tasksCollectionRef;
        let unsubscribe = () => {};

        // --- UI ELEMENTS ---
        const taskListEl = document.getElementById('taskList');
        const loadingEl = document.getElementById('loading');
        const controlsEl = document.getElementById('controls');
        const addTaskBtn = document.getElementById('addTaskBtn');
        const searchInput = document.getElementById('searchInput');
        const sortSelect = document.getElementById('sortSelect');
        const filterSelect = document.getElementById('filterSelect');
        const subCategoryFilter = document.getElementById('subCategoryFilter');
        const modal = document.getElementById('taskModal');
        const modalBackdrop = modal.querySelector('.modal-backdrop');
        const modalContent = modal.querySelector('.modal-content');
        const taskForm = document.getElementById('taskForm');
        const modalTitle = document.getElementById('modalTitle');
        const cancelBtn = document.getElementById('cancelBtn');
        const themeToggleBtn = document.getElementById('theme-toggle');
        const themeToggleDarkIcon = document.getElementById('theme-toggle-dark-icon');
        const themeToggleLightIcon = document.getElementById('theme-toggle-light-icon');


        let allTasks = [];

        // --- AUTHENTICATION ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                tasksCollectionRef = collection(db, `users/${userId}/tasks`);
                await loadAndDisplayTasks();
            }
        });

        async function initializeAuth() {
            try {
                await signInAnonymously(auth);
            } catch (error) {
                console.error("Anonymous authentication failed:", error);
                loadingEl.innerText = "Error: Could not authenticate.";
            }
        }
        
        // --- DATA HANDLING & RENDERING ---
        async function loadAndDisplayTasks() {
            loadingEl.style.display = 'block';
            try {
                const querySnapshot = await getDocs(tasksCollectionRef);
                if (querySnapshot.empty) {
                    await populateInitialData();
                }

                unsubscribe();
                unsubscribe = onSnapshot(tasksCollectionRef, (snapshot) => {
                    allTasks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderTasks();
                    loadingEl.style.display = 'none';
                    controlsEl.style.display = 'flex';
                }, (error) => {
                    console.error("Error with real-time listener:", error);
                    loadingEl.innerText = "Error loading tasks.";
                });
            } catch (error) {
                console.error("Error loading tasks:", error);
                loadingEl.innerText = "Error loading tasks.";
            }
        }
        
        async function populateInitialData() {
            const initialTasks = parseInitialData(rawData);
            if (initialTasks.length > 0) {
                const batch = writeBatch(db);
                initialTasks.forEach(task => {
                    const newDocRef = doc(tasksCollectionRef);
                    batch.set(newDocRef, task);
                });
                await batch.commit();
            }
        }

        function renderTasks() {
            let tasksToRender = [...allTasks];
            
            const searchTerm = searchInput.value.toLowerCase();
            if (searchTerm) {
                tasksToRender = tasksToRender.filter(task => 
                    task.content.toLowerCase().includes(searchTerm) ||
                    (task.comment && task.comment.toLowerCase().includes(searchTerm))
                );
            }
            
            const filterValue = filterSelect.value;
            if (filterValue !== 'all') {
                tasksToRender = tasksToRender.filter(task => task.category === filterValue);
            }

            const subCategoryValue = subCategoryFilter.value;
            if (subCategoryValue !== 'all') {
                tasksToRender = tasksToRender.filter(task => task.subCategory === subCategoryValue);
            }

            const sortValue = sortSelect.value;
            tasksToRender.sort((a, b) => {
                if (a.completed !== b.completed) return a.completed ? 1 : -1;
                switch (sortValue) {
                    case 'priority': return a.priority - b.priority;
                    case 'content-asc': return a.content.localeCompare(b.content);
                    case 'content-desc': return b.content.localeCompare(a.content);
                    default: return 0;
                }
            });
            
            taskListEl.innerHTML = tasksToRender.map(createTaskCardHTML).join('');
        }

        function createTaskCardHTML(task) {
            const isCompleted = task.completed ? 'completed' : '';
            const isChecked = task.completed ? 'checked' : '';
            const typeColor = task.category === 'project' ? 'bg-purple-100 dark:bg-purple-900/50 text-purple-800 dark:text-purple-200' : 'bg-green-100 dark:bg-green-900/50 text-green-800 dark:text-green-200';
            const subCatCap = task.subCategory.charAt(0).toUpperCase() + task.subCategory.slice(1);
            const catCap = task.category.charAt(0).toUpperCase() + task.category.slice(1);
            const fullTypeLabel = `${subCatCap} ${catCap}`;

            return `
                <div id="task-${task.id}" class="task-card ${isCompleted} bg-white dark:bg-gray-800 rounded-lg shadow-md border-l-4 flex flex-col transition-all duration-300">
                    <div class="p-4 flex-grow">
                        <div class="flex justify-between items-start">
                           <p class="task-content font-bold text-lg text-gray-800 dark:text-gray-100 flex-1 mr-4">${task.content}</p>
                           <input type="checkbox" data-id="${task.id}" class="task-checkbox h-6 w-6 rounded border-gray-300 dark:border-gray-600 text-blue-600 focus:ring-blue-500 cursor-pointer" ${isChecked}>
                        </div>
                        ${task.comment ? `<p class="text-sm text-gray-500 dark:text-gray-400 mt-2">${task.comment}</p>` : ''}
                    </div>
                    <div class="p-4 bg-gray-50 dark:bg-gray-800/50 rounded-b-lg border-t border-gray-200 dark:border-gray-700 flex justify-between items-center text-sm">
                        <div class="flex items-center gap-4 flex-wrap">
                            <span class="font-semibold text-gray-600 dark:text-gray-300">
                                <i class="fas fa-clock mr-1 text-gray-400 dark:text-gray-500"></i>
                                ${task.duration} ${task.durationUnit}(s)
                            </span>
                            <span class="px-2 py-1 text-xs font-medium rounded-full ${typeColor}">${fullTypeLabel}</span>
                        </div>
                        <div>
                            <button data-id="${task.id}" class="edit-btn text-gray-400 dark:text-gray-500 hover:text-blue-500 dark:hover:text-blue-400 transition-colors"><i class="fas fa-edit"></i></button>
                            <button data-id="${task.id}" class="delete-btn text-gray-400 dark:text-gray-500 hover:text-red-500 dark:hover:text-red-400 transition-colors ml-2"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // --- MODAL HANDLING ---
        function openModal(task = null) {
            taskForm.reset();
            if (task) {
                modalTitle.innerText = "Edit Task";
                document.getElementById('taskId').value = task.id;
                document.getElementById('content').value = task.content;
                document.getElementById('priority').value = task.priority;
                document.getElementById('category').value = task.category;
                document.getElementById('subCategory').value = task.subCategory;
                document.getElementById('duration').value = task.duration;
                document.getElementById('durationUnit').value = task.durationUnit;
                document.getElementById('comment').value = task.comment;
            } else {
                modalTitle.innerText = "Add New Task";
                document.getElementById('taskId').value = '';
            }
            modal.classList.remove('hidden');
            setTimeout(() => {
                modalBackdrop.classList.remove('opacity-0');
                modalContent.classList.remove('scale-95');
            }, 10);
        }

        function closeModal() {
            modalBackdrop.classList.add('opacity-0');
            modalContent.classList.add('scale-95');
             setTimeout(() => modal.classList.add('hidden'), 300);
        }

        // --- EVENT LISTENERS ---
        searchInput.addEventListener('input', renderTasks);
        sortSelect.addEventListener('change', renderTasks);
        filterSelect.addEventListener('change', renderTasks);
        subCategoryFilter.addEventListener('change', renderTasks);

        addTaskBtn.addEventListener('click', () => openModal());
        cancelBtn.addEventListener('click', closeModal);
        modalBackdrop.addEventListener('click', closeModal);
        
        taskForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('taskId').value;
            const taskData = {
                content: document.getElementById('content').value,
                priority: parseInt(document.getElementById('priority').value, 10),
                category: document.getElementById('category').value,
                subCategory: document.getElementById('subCategory').value,
                duration: parseInt(document.getElementById('duration').value, 10),
                durationUnit: document.getElementById('durationUnit').value,
                comment: document.getElementById('comment').value,
                responsible: 'Trevor',
            };

            try {
                if (id) {
                    const docRef = doc(db, `users/${userId}/tasks`, id);
                    await updateDoc(docRef, taskData);
                } else {
                    taskData.completed = false;
                    taskData.createdAt = new Date();
                    await addDoc(tasksCollectionRef, taskData);
                }
                closeModal();
            } catch (error) {
                console.error("Error saving task: ", error);
            }
        });

        taskListEl.addEventListener('click', async (e) => {
            const card = e.target.closest('.task-card');
            if (!card) return;
            const id = card.id.replace('task-','');
            
            if (e.target.matches('.task-checkbox')) {
                const docRef = doc(db, `users/${userId}/tasks`, id);
                await updateDoc(docRef, { completed: e.target.checked });
            }
            
            if (e.target.closest('.delete-btn')) {
                e.preventDefault();
                if (window.confirm('Are you sure you want to delete this task?')) {
                    const docRef = doc(db, `users/${userId}/tasks`, id);
                    await deleteDoc(docRef);
                }
            }

            if (e.target.closest('.edit-btn')) {
                e.preventDefault();
                const taskToEdit = allTasks.find(t => t.id === id);
                if (taskToEdit) openModal(taskToEdit);
            }
        });

        // --- THEME TOGGLE ---
        if (document.documentElement.classList.contains('dark')) {
            themeToggleLightIcon.classList.remove('hidden');
        } else {
            themeToggleDarkIcon.classList.remove('hidden');
        }

        themeToggleBtn.addEventListener('click', () => {
            themeToggleDarkIcon.classList.toggle('hidden');
            themeToggleLightIcon.classList.toggle('hidden');
            const isDark = document.documentElement.classList.toggle('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
        });
        
        // Kick off the authentication process immediately on script load.
        initializeAuth();

    </script>

</body>
</html>
