<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Quiz App</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom scrollbar for the tabs */
        .tab-scroll::-webkit-scrollbar {
            height: 8px;
        }
        .tab-scroll::-webkit-scrollbar-thumb {
            background-color: #cbd5e1; /* slate-300 */
            border-radius: 10px;
        }
        .tab-scroll::-webkit-scrollbar-track {
            background-color: #f1f5f9; /* slate-100 */
        }
        /* Active tab style */
        .tab-active {
            border-color: #3b82f6; /* blue-500 */
            background-color: #eff6ff; /* blue-50 */
            color: #2563eb; /* blue-600 */
            font-weight: 600;
        }
        
        /* Answer feedback styles */
        .correct-answer {
            background-color: #dcfce7; /* green-100 */
            border-color: #22c55e; /* green-500 */
        }
        .incorrect-answer {
            background-color: #fee2e2; /* red-100 */
            border-color: #ef4444; /* red-500 */
        }
        .answer-label {
            display: flex;
            align-items: center;
            padding: 0.75rem; /* p-3 */
            border-width: 1px;
            border-color: #e2e8f0; /* slate-200 */
            border-radius: 0.5rem; /* rounded-lg */
            cursor: pointer;
            transition: background-color 0.15s ease-in-out;
        }
        .answer-label:hover {
            background-color: #f8fafc; /* slate-50 */
        }
        .answer-label input {
            margin-right: 0.75rem; /* mr-3 */
        }
        /* Simple spinner */
        .spinner {
            border: 4px solid #f3f3f3; /* Light grey */
            border-top: 4px solid #3b82f6; /* Blue */
            border-radius: 50%;
            width: 32px;
            height: 32px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Style for the <details> summary */
        details > summary {
            cursor: pointer;
            list-style: none; /* Remove default triangle */
        }
        details > summary::-webkit-details-marker {
            display: none; /* Remove default triangle */
        }
        details > summary::before {
            content: 'â–¶'; /* Collapsed state */
            margin-right: 0.5rem;
            display: inline-block;
            transition: transform 0.2s;
        }
        details[open] > summary::before {
            transform: rotate(90deg); /* Expanded state */
        }
    </style>
</head>
<body class="bg-slate-100 font-sans p-4 md:p-8">

    <!-- Firebase SDK Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged,
            setPersistence,
            inMemoryPersistence,
            GoogleAuthProvider,
            signInWithPopup,
            signOut
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            setDoc, 
            addDoc, 
            collection, 
            getDocs, 
            query, 
            where, 
            serverTimestamp,
            writeBatch,
            setLogLevel
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- GLOBAL APP STATE ---
        let db, auth, appId, userId;
        let selectedBookId = null;
        let selectedChapterId = null;
        let newQuizQuestions = []; // Temporary array for the new quiz form
        const adminEmail = "techride.trevor@gmail.com"; // Admin email check

        // --- UI ELEMENT HOOKS ---
        const authStatus = document.getElementById('auth-status');
        const userDisplayName = document.getElementById('user-display-name');
        const signOutButton = document.getElementById('sign-out-button');
        const mainLoading = document.getElementById('main-loading');
        const loginContainer = document.getElementById('login-container');
        const loginButton = document.getElementById('login-button');
        const appContainer = document.getElementById('app-container');
        
        // Admin Panel (gets shown/hidden based on email)
        const adminPanelContainer = document.getElementById('admin-panel-container');

        // Seeder
        const seedButton = document.getElementById('seed-button');
        const seedLoading = document.getElementById('seed-loading');
        const seedMessage = document.getElementById('seed-message');
        
        // Main Quiz UI
        const bookList = document.getElementById('book-list');
        const chapterTabs = document.getElementById('chapter-tabs');
        const quizContainer = document.getElementById('quiz-container');
        const sectionTitle = document.getElementById('section-title');

        // Admin Panel: Create Book
        const createBookForm = document.getElementById('create-book-form');
        const bookTitleInput = document.getElementById('book-title-input');
        const bookAuthorInput = document.getElementById('book-author-input');
        const createBookMessage = document.getElementById('create-book-message');

        // Admin Panel: Create Quiz
        const createQuizForm = document.getElementById('create-quiz-form');
        const adminBookSelect = document.getElementById('admin-book-select');
        const adminChapterTitle = document.getElementById('admin-chapter-title');
        const adminQuestionList = document.getElementById('admin-question-list');
        const addQuestionButton = document.getElementById('add-question-button');
        const saveChapterButton = document.getElementById('save-chapter-button');
        const createChapterMessage = document.getElementById('create-chapter-message');

        // Admin Panel: New Question Modal (part of create-quiz-form)
        const newQuestionModal = document.getElementById('new-question-modal');
        const questionTextInput = document.getElementById('question-text-input');
        const questionTypeSelect = document.getElementById('question-type-select');
        const mcqOptionsContainer = document.getElementById('mcq-options-container');
        const shortAnswerContainer = document.getElementById('short-answer-container');
        const shortAnswerInput = document.getElementById('short-answer-input');
        const mcqOptionInputs = document.getElementById('mcq-option-inputs');
        const addOptionButton = document.getElementById('add-option-button');
        const mcqCorrectAnswerSelect = document.getElementById('mcq-correct-answer-select');
        const saveQuestionButton = document.getElementById('save-question-button');
        const cancelQuestionButton = document.getElementById('cancel-question-button');

        // --- 1. FIREBASE INITIALIZATION ---
        async function initFirebase() {
            try {
                
                // !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
                // !! IMPORTANT: PASTE YOUR FIREBASE CONFIG HERE !!
                // !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
                // You can get this from your Firebase project console:
                // Project Settings > General > Your apps > Web app
                const firebaseConfig = {
                    apiKey: "AIzaSyBqBn-aP35BlJY1FeLgfaf6I8cyMRzxKhU",
                    authDomain: "bainter-book-quizzes.firebaseapp.com",
                    projectId: "bainter-book-quizzes",
                    storageBucket: "bainter-book-quizzes.firebasestorage.app",
                    messagingSenderId: "1029138348029",
                    appId: "1:1029138348029:web:77bc8b96f0a86bbfd38b94"
                };
                
                // --- This is the new App ID ---
                appId = firebaseConfig.projectId; // Use your project ID as the app ID
                
                if (firebaseConfig.apiKey.startsWith("YOUR_")) {
                    authStatus.textContent = "Error: Please paste your Firebase config into quiz_app.html.";
                    mainLoading.classList.add('hidden');
                    return;
                }

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('Debug'); // Enable detailed Firestore logs

                // Use in-memory persistence for this demo
                await setPersistence(auth, inMemoryPersistence);

                setupAuthListener();
            } catch (error) {
                console.error("Firebase Init Error:", error);
                authStatus.textContent = "Error initializing Firebase.";
            }
        }

        // --- 2. AUTHENTICATION ---
        function setupAuthListener() {
            onAuthStateChanged(auth, async (user) => {
                mainLoading.classList.add('hidden'); // Hide loading spinner
                adminPanelContainer.classList.add('hidden'); // Hide admin panel by default

                if (user) {
                    // --- User is SIGNED IN ---
                    userId = user.uid;
                    authStatus.textContent = "Signed in as:";
                    userDisplayName.textContent = `${user.displayName} (${user.email})`;
                    signOutButton.classList.remove('hidden');
                    
                    appContainer.classList.remove('hidden'); // Show the main app
                    loginContainer.classList.add('hidden');  // Hide the login button

                    // Add sign-out functionality
                    signOutButton.onclick = () => signOut(auth);
                    
                    // *** ADMIN CHECK ***
                    // Check if the signed-in user is the admin
                    if (user.email === adminEmail) {
                        adminPanelContainer.classList.remove('hidden'); // Show the admin panel
                    }
                    
                    // Once authenticated, load the books
                    await loadBooks();
                } else {
                    // --- User is SIGNED OUT ---
                    userId = null;
                    authStatus.textContent = "Please sign in to start.";
                    userDisplayName.textContent = "";
                    signOutButton.classList.add('hidden');
                    
                    appContainer.classList.add('hidden');    // Hide the main app
                    loginContainer.classList.remove('hidden');// Show the login button
                }
            });
        }

        /**
         * Triggers the Google Sign-in Popup
         */
        async function signInWithGoogle() {
            const provider = new GoogleAuthProvider();
            try {
                // This will trigger the onAuthStateChanged listener
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error("Google Sign-in Error:", error);
                authStatus.textContent = "Error signing in. Please try again.";
            }
        }
        
        // Add listener to the login button
        loginButton.onclick = signInWithGoogle;


        // --- 3. DATA LOADING (PUBLIC) ---
        
        /**
         * Loads books for BOTH the main quiz list and the admin panel dropdown
         */
        async function loadBooks() {
            if (!db || !appId) return;

            showLoading(bookList, "Loading books...");
            bookList.innerHTML = '';
            adminBookSelect.innerHTML = '<option value="">Select a book...</option>'; // Clear admin dropdown
            
            try {
                const bookCollectionRef = collection(db, `artifacts/${appId}/public/data/books`);
                const querySnapshot = await getDocs(bookCollectionRef);
                
                if (querySnapshot.empty) {
                    bookList.innerHTML = '<p class="text-slate-500">No books found. Have you seeded the database?</p>';
                    return;
                }

                querySnapshot.forEach((doc) => {
                    const book = doc.data();
                    
                    // 1. Populate main quiz list
                    const bookButton = document.createElement('button');
                    bookButton.className = "w-full text-left p-4 bg-white hover:bg-slate-50 border rounded-lg shadow-sm";
                    bookButton.innerHTML = `
                        <h3 class="font-semibold text-lg text-blue-600">${book.title}</h3>
                        <p class="text-sm text-slate-600">by ${book.author}</p>
                    `;
                    bookButton.onclick = () => {
                        selectedBookId = doc.id;
                        loadChapters(doc.id, book.title);
                    };
                    bookList.appendChild(bookButton);

                    // 2. Populate admin dropdown
                    const bookOption = document.createElement('option');
                    bookOption.value = doc.id;
                    bookOption.textContent = book.title;
                    adminBookSelect.appendChild(bookOption);
                });
            } catch (error) {
                console.error("Error loading books:", error);
                bookList.innerHTML = '<p class="text-red-500">Error loading books. Check console.</p>';
            }
        }

        /**
         * Loads chapters for a selected book
         */
        async function loadChapters(bookId, bookTitle) {
            sectionTitle.textContent = `${bookTitle} Chapters`;
            showLoading(chapterTabs, "Loading chapters...");
            quizContainer.innerHTML = '';
            chapterTabs.innerHTML = '';

            try {
                const chapterCollectionRef = collection(db, `artifacts/${appId}/public/data/books/${bookId}/chapters`);
                const querySnapshot = await getDocs(chapterCollectionRef);
                
                if (querySnapshot.empty) {
                    chapterTabs.innerHTML = '<p class="text-slate-500">No chapters found for this book.</p>';
                    return;
                }
                
                // Sort chapters by title (e.g., "Chapter 1", "Chapter 2")
                const chapters = [];
                querySnapshot.forEach(doc => {
                    chapters.push({ id: doc.id, ...doc.data() });
                });
                // Simple sort, assumes "Chapter X" format
                chapters.sort((a, b) => {
                    const numA = parseInt(a.title.split(' ')[1]);
                    const numB = parseInt(b.title.split(' ')[1]);
                    return numA - numB;
                });


                chapters.forEach((chapter, index) => {
                    const tabButton = document.createElement('button');
                    tabButton.className = "tab-button whitespace-nowrap py-4 px-4 border-b-2 border-transparent font-medium text-sm text-slate-500 hover:text-blue-600 hover:border-blue-300";
                    tabButton.textContent = `Ch. ${index + 1}`;
                    tabButton.dataset.chapterId = chapter.id;

                    if (index === 0) {
                        tabButton.classList.add('tab-active');
                        selectedChapterId = chapter.id;
                        loadQuiz(bookId, chapter.id);
                    }

                    tabButton.onclick = () => {
                        // Deactivate all tabs
                        chapterTabs.querySelectorAll('.tab-button').forEach(t => t.classList.remove('tab-active'));
                        // Activate clicked tab
                        tabButton.classList.add('tab-active');
                        selectedChapterId = chapter.id;
                        loadQuiz(bookId, chapter.id);
                    };
                    chapterTabs.appendChild(tabButton);
                });

            } catch (error) {
                console.error("Error loading chapters:", error);
                chapterTabs.innerHTML = '<p class="text-red-500">Error loading chapters. Check console.</p>';
            }
        }

        /**
         * Loads the quiz questions for a selected chapter
         */
        async function loadQuiz(bookId, chapterId) {
            showLoading(quizContainer, "Loading quiz...");
            quizContainer.innerHTML = '';

            try {
                const questionsCollectionRef = collection(db, `artifacts/${appId}/public/data/books/${bookId}/chapters/${chapterId}/questions`);
                const querySnapshot = await getDocs(questionsCollectionRef);

                if (querySnapshot.empty) {
                    quizContainer.innerHTML = '<p class="text-slate-500">No questions found for this chapter.</p>';
                    return;
                }
                
                const questions = [];
                querySnapshot.forEach(doc => {
                    questions.push({ id: doc.id, ...doc.data() });
                });
                
                // Sort by question number
                questions.sort((a, b) => a.order - b.order);

                const quizForm = document.createElement('div');
                quizForm.className = "space-y-6";

                questions.forEach((q, index) => {
                    const questionDiv = document.createElement('div');
                    questionDiv.dataset.questionId = q.id;
                    questionDiv.dataset.correct = q.correctAnswer;
                    questionDiv.dataset.type = q.type;

                    let questionHTML = `<p class="font-medium mb-2">${index + 1}. ${q.text}</p>`;
                    
                    if (q.type === 'mcq') {
                        questionHTML += '<div class="space-y-2">';
                        q.options.forEach((option, optionIndex) => {
                            questionHTML += `
                                <label class="answer-label">
                                    <input type="radio" name="q-${q.id}" value="${optionIndex}">
                                    <span>${option}</span>
                                </label>
                            `;
                        });
                        questionHTML += '</div>';
                    } else if (q.type === 'short_answer') {
                        questionHTML += `
                            <textarea class="w-full p-2 border border-slate-300 rounded-md" rows="2" placeholder="Type your answer here..."></textarea>
                            <div class="answer-feedback text-sm mt-2 hidden p-3 bg-blue-50 border border-blue-200 rounded-md"></div>
                        `;
                    }
                    questionDiv.innerHTML = questionHTML;
                    quizForm.appendChild(questionDiv);
                });

                // Add controls
                const controlsDiv = document.createElement('div');
                controlsDiv.className = "quiz-controls mt-6";
                controlsDiv.innerHTML = `
                    <button id="check-quiz-btn" class="px-5 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600">Check Answers & Save</button>
                    <div class="quiz-results mt-4 font-semibold text-lg hidden"></div>
                `;
                
                quizContainer.appendChild(quizForm);
                quizContainer.appendChild(controlsDiv);

                // Add event listener to the new button
                document.getElementById('check-quiz-btn').onclick = (e) => {
                    const btn = e.target;
                    if (btn.textContent.includes('Check')) {
                        checkAndSaveQuiz(bookId, chapterId);
                        btn.textContent = 'Quiz Saved! Reset?';
                    } else {
                        // Reset
                        loadQuiz(bookId, chapterId);
                    }
                };

            } catch (error) {
                console.error("Error loading quiz:", error);
                quizContainer.innerHTML = '<p class="text-red-500">Error loading quiz. Check console.</p>';
            }
        }

        // --- 4. QUIZ SUBMISSION (PRIVATE) ---
        async function checkAndSaveQuiz(bookId, chapterId) {
            if (!userId) return; // Should not happen if user is logged in

            const questions = quizContainer.querySelectorAll('[data-question-id]');
            const resultsDiv = quizContainer.querySelector('.quiz-results');
            let score = 0;
            let total = 0;
            const userAnswers = [];

            questions.forEach(q => {
                const questionId = q.dataset.questionId;
                const type = q.dataset.type;
                const correctAnswer = q.dataset.correct;

                if (type === 'mcq') {
                    total++;
                    const checkedRadio = q.querySelector('input[type="radio"]:checked');
                    const correctLabel = q.querySelector(`input[value="${correctAnswer}"]`)?.closest('label');

                    if (correctLabel) {
                        correctLabel.classList.add('correct-answer');
                    }

                    let selectedAnswerIndex = null;
                    let isCorrect = false;

                    if (checkedRadio) {
                        const checkedLabel = checkedRadio.closest('label');
                        selectedAnswerIndex = parseInt(checkedRadio.value);
                        
                        if (checkedRadio.value === correctAnswer) {
                            score++;
                            isCorrect = true;
                        } else {
                            checkedLabel.classList.add('incorrect-answer');
                        }
                    }
                    userAnswers.push({ questionId, type, answer: selectedAnswerIndex, isCorrect });
                } else if (type === 'short_answer') {
                    const textarea = q.querySelector('textarea');
                    const feedbackDiv = q.querySelector('.answer-feedback');
                    feedbackDiv.innerHTML = `<strong>Suggested Answer:</strong> ${correctAnswer}`;
                    feedbackDiv.classList.remove('hidden');
                    
                    userAnswers.push({ questionId, type, answer: textarea.value, modelAnswer: correctAnswer });
                }
            });

            // Display results
            if (total > 0) {
                resultsDiv.innerHTML = `You got ${score} out of ${total} multiple-choice questions correct. Score saved!`;
                resultsDiv.classList.remove('hidden');
            }

            // Save to Firestore
            try {
                const attemptData = {
                    userId,
                    bookId,
                    chapterId,
                    score,
                    total,
                    answers: userAnswers,
                    timestamp: serverTimestamp()
                };
                const attemptCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/quizAttempts`);
                await addDoc(attemptCollectionRef, attemptData);
                console.log("Quiz attempt saved!");

            } catch (error) {
                console.error("Error saving quiz attempt:", error);
                resultsDiv.innerHTML += ' <span class="text-red-500">(Error saving score)</span>';
            }
        }
        
        // --- 5. UI HELPERS ---
        function showLoading(container, message) {
            container.innerHTML = `
                <div class="flex flex-col items-center justify-center p-8 text-slate-500">
                    <div class="spinner"></div>
                    <p class="mt-4">${message}</p>
                </div>
            `;
        }

        // --- 6. ADMIN PANEL LOGIC ---

        // 6a. Create New Book
        createBookForm.onsubmit = async (e) => {
            e.preventDefault();
            const title = bookTitleInput.value.trim();
            const author = bookAuthorInput.value.trim();

            if (!title || !author) {
                createBookMessage.textContent = "Please fill out both title and author.";
                createBookMessage.className = "text-sm text-red-600";
                return;
            }

            try {
                const bookCollectionRef = collection(db, `artifacts/${appId}/public/data/books`);
                await addDoc(bookCollectionRef, { title, author });

                createBookMessage.textContent = "Successfully added book!";
                createBookMessage.className = "text-sm text-green-600";
                bookTitleInput.value = '';
                bookAuthorInput.value = '';
                await loadBooks(); // Refresh book lists
            } catch (error) {
                console.error("Error adding book:", error);
                createBookMessage.textContent = "Error adding book. See console.";
                createBookMessage.className = "text-sm text-red-600";
            }
        };

        // 6b. Create New Quiz (Modal and Form Logic)
        
        // Show/hide question types
        questionTypeSelect.onchange = () => {
            if (questionTypeSelect.value === 'mcq') {
                mcqOptionsContainer.classList.remove('hidden');
                shortAnswerContainer.classList.add('hidden');
            } else {
                mcqOptionsContainer.classList.add('hidden');
                shortAnswerContainer.classList.remove('hidden');
            }
        };

        // Add a new option input field for MCQs
        addOptionButton.onclick = () => {
            const optionIndex = mcqOptionInputs.children.length;
            const newOptionInput = document.createElement('input');
            newOptionInput.type = "text";
            newOptionInput.placeholder = `Option ${optionIndex + 1}`;
            newOptionInput.className = "w-full p-2 border border-slate-300 rounded-md";
            mcqOptionInputs.appendChild(newOptionInput);
            
            // Add to the "correct answer" dropdown
            const newCorrectOption = document.createElement('option');
            newCorrectOption.value = optionIndex;
            newCorrectOption.textContent = `Option ${optionIndex + 1}`;
            mcqCorrectAnswerSelect.appendChild(newCorrectOption);
        };

        // Show the "Add Question" modal
        addQuestionButton.onclick = () => {
            resetQuestionModal();
            newQuestionModal.classList.remove('hidden');
        };

        // Hide the "Add Question" modal
        cancelQuestionButton.onclick = () => {
            newQuestionModal.classList.add('hidden');
        };

        // Reset the question modal to its default state
        function resetQuestionModal() {
            questionTextInput.value = '';
            questionTypeSelect.value = 'mcq';
            shortAnswerInput.value = '';
            mcqOptionInputs.innerHTML = '';
            mcqCorrectAnswerSelect.innerHTML = '';
            
            // Add 2 default options
            addOptionButton.click();
            addOptionButton.click();
            
            mcqOptionsContainer.classList.remove('hidden');
            shortAnswerContainer.classList.add('hidden');
        }

        // Save the question from the modal to the temporary array
        saveQuestionButton.onclick = () => {
            const text = questionTextInput.value.trim();
            const type = questionTypeSelect.value;
            if (!text) {
                alert("Please enter question text.");
                return;
            }

            let questionData = {
                order: newQuizQuestions.length + 1,
                text,
                type
            };

            if (type === 'mcq') {
                const options = [];
                const optionInputs = mcqOptionInputs.querySelectorAll('input');
                optionInputs.forEach(input => {
                    if (input.value.trim()) {
                        options.push(input.value.trim());
                    }
                });
                if (options.length < 2) {
                    alert("Please add at least 2 options.");
                    return;
                }
                questionData.options = options;
                questionData.correctAnswer = mcqCorrectAnswerSelect.value;
            } else {
                const answer = shortAnswerInput.value.trim();
                if (!answer) {
                    alert("Please provide a model answer.");
                    return;
                }
                questionData.correctAnswer = answer;
            }

            // Add to temporary array
            newQuizQuestions.push(questionData);
            
            // Update the UI list
            const questionItem = document.createElement('li');
            questionItem.className = "text-sm text-slate-700";
            questionItem.textContent = `${questionData.order}. ${questionData.text}`;
            adminQuestionList.appendChild(questionItem);
            
            newQuestionModal.classList.add('hidden');
        };

        // 6c. Save the whole chapter (with questions) to Firestore
        saveChapterButton.onclick = async () => {
            const bookId = adminBookSelect.value;
            const chapterTitle = adminChapterTitle.value.trim();

            if (!bookId || !chapterTitle || newQuizQuestions.length === 0) {
                createChapterMessage.textContent = "Please select a book, enter a chapter title, and add at least one question.";
                createChapterMessage.className = "text-sm text-red-600";
                return;
            }

            saveChapterButton.disabled = true;
            createChapterMessage.textContent = "Saving chapter...";
            createChapterMessage.className = "text-sm text-blue-600";
            
            try {
                const batch = writeBatch(db);
                
                // 1. Create the new chapter document
                const chapterRef = doc(collection(db, `artifacts/${appId}/public/data/books/${bookId}/chapters`));
                batch.set(chapterRef, { title: chapterTitle });
                
                // 2. Add all questions from the temporary array to its subcollection
                for (const question of newQuizQuestions) {
                    const questionRef = doc(collection(db, chapterRef.path, "questions"));
                    batch.set(questionRef, question);
                }
                
                // 3. Commit the batch
                await batch.commit();

                createChapterMessage.textContent = "Successfully saved new chapter!";
                createChapterMessage.className = "text-sm text-green-600";
                
                // Reset the form
                adminBookSelect.value = '';
                adminChapterTitle.value = '';
                adminQuestionList.innerHTML = '';
                newQuizQuestions = [];
                saveChapterButton.disabled = false;
                
                // Reload books in case the user's new chapter was for a new book
                // (This is redundant if they just added to an existing book, but safe)
                await loadBooks();
                
            } catch (error) {
                console.error("Error saving chapter:", error);
                createChapterMessage.textContent = "Error saving chapter. See console.";
                createChapterMessage.className = "text-sm text-red-600";
                saveChapterButton.disabled = false;
            }
        };

        // --- 7. DATABASE SEEDER (RUN ONCE) ---
        seedButton.onclick = async () => {
            seedButton.disabled = true;
            seedLoading.classList.remove('hidden');
            seedMessage.textContent = 'Seeding in progress... This may take a moment.';

            try {
                // Check if already seeded
                const bookRef = doc(db, `artifacts/${appId}/public/data/books/shiloh`);
                const bookSnap = await getDoc(bookRef);
                if (bookSnap.exists()) {
                    seedMessage.textContent = 'Database already contains "Shiloh". Loading books.';
                    seedLoading.classList.add('hidden');
                    await loadBooks();
                    return;
                }

                // --- Start Seeding ---
                const batch = writeBatch(db);
                
                // 1. Create the Book
                batch.set(bookRef, {
                    title: "Shiloh",
                    author: "Phyllis Reynolds Naylor"
                });

                // 2. Add all chapters and questions
                // This uses the data from our static file.
                const shilohData = getShilohSeedData();

                for (const chapter of shilohData) {
                    // Create a chapter doc
                    const chapterRef = doc(collection(db, `artifacts/${appId}/public/data/books/shiloh/chapters`));
                    batch.set(chapterRef, { title: chapter.title });

                    // Create question subcollection
                    for (const question of chapter.questions) {
                        const questionRef = doc(collection(db, chapterRef.path, "questions"));
                        batch.set(questionRef, question);
                    }
                }

                // 3. Commit the batch
                await batch.commit();

                seedLoading.classList.add('hidden');
                seedMessage.textContent = 'Seeding complete! "Shiloh" is now in the database.';
                seedButton.classList.add('hidden');
                
                // Reload the book list
                await loadBooks();

            } catch (error) {
                console.error("Database Seeding Error:", error);
                seedLoading.classList.add('hidden');
                seedMessage.textContent = 'Error seeding database. See console for details.';
                seedButton.disabled = false;
            }
        };
        
        /**
         * Contains all quiz data for Shiloh.
         * This is a helper function just for seeding.
         */
        function getShilohSeedData() {
            return [
                { title: 'Chapter 1', questions: [
                    { order: 1, type: 'mcq', text: 'What kind of dog does Marty find?', options: ['A golden retriever', 'A beagle', 'A german shepherd'], correctAnswer: '1' },
                    { order: 2, type: 'mcq', text: 'What does Marty name the dog?', options: ['Buddy', 'Sparky', 'Shiloh'], correctAnswer: '2' },
                    { order: 3, type: 'mcq', text: "Who is the dog's mean owner?", options: ['Mr. Preston', 'Judd Travers', 'Doc Murphy'], correctAnswer: '1' },
                    { order: 4, type: 'short_answer', text: 'Why is Marty worried about the dog?', correctAnswer: "He thinks Judd Travers abuses the dog (kicks him and doesn't feed him enough)." }
                ]},
                { title: 'Chapter 2', questions: [
                    { order: 1, type: 'mcq', text: 'What does Marty decide to do with Shiloh?', options: ['Hide him from his family and Judd', 'Take him back to Judd right away', 'Give him to Doc Murphy'], correctAnswer: '0' },
                    { order: 2, type: 'mcq', text: 'Where does Marty make a pen for Shiloh?', options: ['In his bedroom', 'In the barn', 'On the hill beyond his house'], correctAnswer: '2' },
                    { order: 3, type: 'mcq', text: 'What does Marty use to make the pen?', options: ['Chicken wire', 'Old fencing and wire', 'Wooden boards'], correctAnswer: '1' },
                    { order: 4, type: 'short_answer', text: 'Who is the first person Marty lies to (or avoids the truth with) about Shiloh?', correctAnswer: "His father (He whistles, and when his dad asks what, he says 'nothing')." }
                ]},
                { title: 'Chapter 3', questions: [
                    { order: 1, type: 'mcq', text: "What is Marty's biggest problem with hiding Shiloh?", options: ['Shiloh keeps barking', 'He needs to get food for him', 'Shiloh keeps escaping'], correctAnswer: '1' },
                    { order: 2, type: 'mcq', text: 'How does Marty get food for Shiloh?', options: ['He buys dog food at the store', 'He asks his friend David for help', 'He saves part of his own supper'], correctAnswer: '2' },
                    { order: 3, type: 'mcq', text: 'Who almost catches Marty with the food?', options: ['His mother (Ma)', 'His sister, Dara Lynn', 'Judd Travers'], correctAnswer: '0' },
                    { order: 4, type: 'short_answer', text: 'What does Marty feel bad about in this chapter?', correctAnswer: 'He feels guilty and bad about lying to his parents.' }
                ]},
                { title: 'Chapter 4', questions: [
                    { order: 1, type: 'mcq', text: 'Who is the first family member to find out about Shiloh?', options: ['His sister Dara Lynn', 'His mother (Ma)', 'His father (Dad)'], correctAnswer: '2' },
                    { order: 2, type: 'mcq', text: 'How does this person find out?', options: ['His dad follows him up the hill', 'Marty confesses and tells him', 'Dara Lynn tattles on him'], correctAnswer: '0' },
                    { order: 3, type: 'mcq', text: "What does Marty's dad say Marty has to do?", options: ['Build a better pen', 'Return Shiloh to Judd Travers', 'Take Shiloh to the vet'], correctAnswer: '1' },
                    { order: 4, type: 'short_answer', text: 'How much time does his dad give him?', correctAnswer: "He gives him until Sunday (a couple of days) to think about it and prepare." }
                ]},
                { title: 'Chapter 5', questions: [
                    { order: 1, type: 'mcq', text: 'Who is the second family member to find out about Shiloh?', options: ['His sister Dara Lynn', 'His mother (Ma)', 'His sister Becky'], correctAnswer: '1' },
                    { order: 2, type: 'mcq', text: 'What terrible thing happens to Shiloh at the end of the chapter?', options: ['He gets badly hurt in a dog fight', 'He runs away for good', 'Judd Travers comes and takes him'], correctAnswer: '0' },
                    { order: 3, type: 'mcq', text: 'What animal attacked Shiloh?', options: ['A coyote', "One of Judd's other dogs", 'A big German shepherd'], correctAnswer: '2' }
                ]},
                { title: 'Chapter 6', questions: [
                    { order: 1, type: 'mcq', text: 'Who do Marty and his dad take Shiloh to for help?', options: ['Judd Travers', 'Doc Murphy', 'Mr. Baker (owner of the German shepherd)'], correctAnswer: '1' },
                    { order: 2, type: 'mcq', text: "What does Marty's dad tell Doc Murphy?", options: ['The whole truth about Marty hiding Shiloh', "A lie, saying it's their dog", 'That they found him hurt on the road'], correctAnswer: '0' },
                    { order: 3, type: 'mcq', text: 'Where does Shiloh stay while he gets better?', options: ["At Marty's house", "At Judd's house", "At Doc Murphy's clinic in a cage"], correctAnswer: '2' }
                ]},
                { title: 'Chapter 7', questions: [
                    { order: 1, type: 'mcq', text: "Who sees Marty visiting Shiloh at Doc Murphy's?", options: ['Judd Travers', 'David Howard', 'His dad'], correctAnswer: '0' },
                    { order: 2, type: 'mcq', text: "Now that the secret is out, what does Marty's dad say will happen?", options: ['They can keep Shiloh', "Shiloh must go back to Judd when he's better", 'They will give Shiloh to David Howard'], correctAnswer: '1' },
                    { order: 3, type: 'mcq', text: "What 'job' does Marty get to help pay for Shiloh's vet bill?", options: ['Mowing lawns', 'Delivering newspapers', 'Collecting cans and bottles to recycle'], correctAnswer: '2' }
                ]},
                { title: 'Chapter 8', questions: [
                    { order: 1, type: 'mcq', text: "Where does Shiloh get to stay once he's better?", options: ["At Doc Murphy's", 'Back with Judd', "At Marty's house, in a box inside"], correctAnswer: '2' },
                    { order: 2, type: 'mcq', text: 'Who comes to the house asking about his dog?', options: ['Judd Travers', 'Doc Murphy', 'Mr. Baker'], correctAnswer: '0' },
                    { order: 3, type: 'mcq', text: 'What does Marty promise his dad he will NOT do?', options: ['Lie to him again', 'Run away with Shiloh', 'Talk to Judd Travers'], correctAnswer: '1' }
                ]},
                { title: 'Chapter 9', questions: [
                    { order: 1, type: 'mcq', text: 'What does Marty offer to do for Judd Travers?', options: ['Pay him $50', 'Give him his collection of cans', 'Work for him'], correctAnswer: '2' },
                    { order: 2, type: 'mcq', text: 'What is the first job Judd gives Marty?', options: ['Clean his chimney', 'Stack firewood', 'Feed his other dogs'], correctAnswer: '1' },
                    { order: 3, type: 'mcq', text: "How does Judd treat Marty while he's working?", options: ['He is mean and calls him names', 'He is surprisingly nice and helpful', 'He ignores him completely'], correctAnswer: '0' }
                ]},
                { title: 'Chapter 10', questions: [
                    { order: 1, type: 'mcq', text: 'On his way to work for Judd, what does Marty see Judd do?', options: ['Hit one of his other dogs', 'Shoot a deer', 'Steal mail from a mailbox'], correctAnswer: '1' },
                    { order: 2, type: 'mcq', text: 'Why is this a big deal?', options: ["It's not hunting season (it's illegal)", 'Judd missed the shot', "The deer was on Marty's land"], correctAnswer: '0' },
                    { order: 3, type: 'mcq', text: 'What does Marty realize this information gives him?', options: ['A reason to be scared of Judd', 'A way to get money from Judd', 'Power over Judd (blackmail)'], correctAnswer: '2' }
                ]},
                { title: 'Chapter 11', questions: [
                    { order: 1, type: 'mcq', text: 'Does Marty tell his dad about the deer?', options: ['Yes, right away', 'No, he keeps it a secret', 'He tells his mom instead'], correctAnswer: '1' },
                    { order: 2, type: 'mcq', text: "When Marty goes to Judd's, what does he ask him?", options: ['If he will sell Shiloh', 'If he shot the deer', 'Why he is so mean to his dogs'], correctAnswer: '0' },
                    { order: 3, type: 'mcq', text: 'How does Marty let Judd know that he saw him shoot the deer?', options: ['He shows him a picture he took', 'He tells him his dad saw him', 'He describes exactly where the deer was'], correctAnswer: '2' }
                ]},
                { title: 'Chapter 12', questions: [
                    { order: 1, type: 'mcq', text: 'What deal does Marty make with Judd for Shiloh?', options: ['Marty will work for Judd', 'Marty will pay Judd $100', 'Marty will keep the deer secret for free'], correctAnswer: '0' },
                    { order: 2, type: 'mcq', text: 'How many hours does Marty have to work?', options: ['10 hours', '20 hours', '40 hours'], correctAnswer: '1' },
                    { order: 3, type: 'mcq', text: 'What is the one condition Judd makes about the deal?', options: ["Marty has to feed Judd's other dogs", 'Marty has to tell his dad', "Marty can't tell anyone about the deer"], correctAnswer: '2' }
                ]},
                { title: 'Chapter 13', questions: [
                    { order: 1, type: 'mcq', text: "How does Judd's treatment of Marty change?", options: ['He gets meaner', 'He is a little nicer (offers a drink)', "It doesn't change at all"], correctAnswer: '1' },
                    { order: 2, type: 'mcq', text: "What does Marty's mom send with him for Judd?", options: ['A piece of pie or cake', 'Money for Shiloh', 'A note for his dad'], correctAnswer: '0' },
                    { order: 3, type: 'mcq', text: 'What does Marty worry about as he gets close to finishing his hours?', options: ['That Judd will give him more work', 'That his dad will find out about the deer', 'That Judd will back out of the deal'], correctAnswer: '2' }
                ]},
                { title: 'Chapter 14', questions: [
                    { order: 1, type: 'mcq', text: 'When Marty finishes his hours, what does Judd do?', options: ['He honors the deal and gives Marty the dog', 'He tries to back out of the deal', 'He tells Marty to work 10 more hours'], correctAnswer: '0' },
                    { order: 2, type: 'mcq', text: 'What does Judd give Marty along with the dog?', options: ['A bag of dog food', 'A dog collar', 'Five dollars'], correctAnswer: '1' },
                    { order: 3, type: 'mcq', text: 'What does Judd admit about Shiloh?', options: ['That he was his favorite dog', 'That he stole him from someone else', 'That he was never a good hunting dog'], correctAnswer: '2' }
                ]},
                { title: 'Chapter 15', questions: [
                    { order: 1, type: 'mcq', text: 'Who is the first person Marty tells the whole truth to (about the deer)?', options: ['His dad', 'His mom', 'David Howard'], correctAnswer: '0' },
                    { order: 2, type: 'mcq', text: "How does Marty's dad react to the news about the deer?", options: ['He is very angry at Marty', 'He makes Marty tell the game warden', 'He is quiet, but understands and is proud'], correctAnswer: '2' },
                    { order: 3, type: 'mcq', text: "What does Marty's dad buy at the end of the book?", options: ['A new dog house', 'A new dog collar', 'A bag of dog treats'], correctAnswer: '1' }
                ]}
            ];
        }

        // --- START THE APP ---
        document.addEventListener('DOMContentLoaded', initFirebase);
    </script>

    <!-- Main App Container -->
    <div class="max-w-4xl mx-auto bg-white rounded-lg shadow-lg overflow-hidden">
        
        <!-- Header & Auth Status -->
        <header class="bg-blue-600 text-white p-6">
            <div class="flex justify-between items-center">
                <h1 class="text-3xl font-bold">Book Quiz App</h1>
                <button id="sign-out-button" class="hidden px-4 py-2 bg-blue-500 hover:bg-blue-400 text-white text-sm font-medium rounded-md">
                    Sign Out
                </button>
            </div>
            <div class="mt-2 p-3 bg-blue-700 rounded-lg text-sm">
                <p id="auth-status" class="font-semibold">Initializing...</p>
                <p id="user-display-name" class="text-blue-200 text-xs break-all"></p>
            </div>
        </header>

        <!-- Initial Loading Spinner -->
        <div id="main-loading" class="p-8 flex flex-col items-center justify-center">
            <div class="spinner"></div>
            <p class="mt-4 text-slate-500">Connecting to Firebase...</p>
        </div>

        <!-- Login View (Hidden by default) -->
        <div id="login-container" class="hidden p-8 flex flex-col items-center justify-center border-b">
            <h2 class="text-2xl font-semibold text-slate-800">Welcome!</h2>
            <p class="text-slate-600 mt-2">Please sign in to continue.</p>
            <button id="login-button" class="mt-6 px-6 py-3 bg-blue-500 text-white font-semibold rounded-lg shadow-md hover:bg-blue-600 flex items-center">
                <svg classM="w-5 h-5 mr-3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"><defs><path id="a" d="M44.5 20H24v8.5h11.8C34.7 33.9 30.1 37 24 37c-7.2 0-13-5.8-13-13s5.8-13 13-13c3.1 0 5.9 1.1 8.1 2.9l6.4-6.4C34.6 4.1 29.6 2 24 2 11.8 2 2 11.8 2 24s9.8 22 22 22c11 0 21-8 21-22 0-1.3-.2-2.7-.5-4z"/></defs><clipPath id="b"><use xlink:href="#a" overflow="visible"/></clipPath><path clip-path="url(#b)" fill="#FBBC05" d="M0 37V11l17 13z"/><path clip-path="url(#b)" fill="#EA4335" d="M0 11l17 13 7-6.1L48 14V0H0z"/><path clip-path="url(#b)" fill="#34A853" d="M0 37l30-23 7.9 1L48 0v48H0z"/><path clip-path="url(#b)" fill="#4285F4" d="M48 48L17 24l-4-3 35-10z"/></svg>
                Sign in with Google
            </button>
        </div>

        <!-- Main App Content (Hidden by default) -->
        <div id="app-container" class="hidden">

            <!-- === NEW: Admin Panel (Hidden by default, shown by JS) === -->
            <div id="admin-panel-container" class="hidden p-6 border-b border-slate-200 bg-slate-50">
                <details>
                    <summary class="text-xl font-semibold text-slate-700">
                        Manage Quizzes (Admin)
                    </summary>

                    <div class="mt-6 pl-6 border-l-4 border-slate-300 space-y-8">

                        <!-- 1. Seeder (Moved inside) -->
                        <div id="seeder-container" class="p-4 border border-slate-200 rounded-lg bg-yellow-50">
                            <h3 class="font-semibold text-lg text-yellow-800">Quickstart: Seed "Shiloh"</h3>
                            <p class="text-sm text-yellow-700 mt-1">If the database is empty, click this to add the "Shiloh" quiz.</p>
                            <button id="seed-button" class="mt-4 px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 disabled:bg-slate-400">
                                Seed Database with "Shiloh"
                            </button>
                            <div id="seed-loading" class="hidden flex items-center mt-4">
                                <div class="spinner !w-5 !h-5 !border-2 !border-t-blue-500"></div>
                                <span class="ml-2 text-sm text-slate-600">Seeding...</span>
                            </div>
                            <p id="seed-message" class="text-sm font-medium text-green-700 mt-2"></p>
                        </div>
                        
                        <!-- 2. Create New Book -->
                        <div class="p-4 border border-slate-200 rounded-lg bg-white">
                            <h3 class="font-semibold text-lg text-slate-800">Add a New Book</h3>
                            <form id="create-book-form" class="mt-4 space-y-3">
                                <div>
                                    <label for="book-title-input" class="block text-sm font-medium text-slate-700">Book Title</label>
                                    <input type="text" id="book-title-input" class="mt-1 w-full p-2 border border-slate-300 rounded-md" required>
                                </div>
                                <div>
                                    <label for="book-author-input" class="block text-sm font-medium text-slate-700">Author</label>
                                    <input type="text" id="book-author-input" class="mt-1 w-full p-2 border border-slate-300 rounded-md" required>
                                </div>
                                <button type="submit" class="px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600">Save Book</button>
                                <p id="create-book-message" class="text-sm mt-2"></p>
                            </form>
                        </div>
                        
                        <!-- 3. Create New Chapter/Quiz -->
                        <div class="p-4 border border-slate-200 rounded-lg bg-white">
                            <h3 class="font-semibold text-lg text-slate-800">Add a New Chapter Quiz</h3>
                            <div id="create-quiz-form" class="mt-4 space-y-4">
                                <div>
                                    <label for="admin-book-select" class="block text-sm font-medium text-slate-700">1. Select Book</label>
                                    <select id="admin-book-select" class="mt-1 w-full p-2 border border-slate-300 rounded-md" required>
                                        <option value="">Select a book...</option>
                                        <!-- Options added by loadBooks() -->
                                    </select>
                                </div>
                                
                                <div>
                                    <label for="admin-chapter-title" class="block text-sm font-medium text-slate-700">2. Enter Chapter Title</label>
                                    <input type="text" id="admin-chapter-title" class="mt-1 w-full p-2 border border-slate-300 rounded-md" placeholder="e.g., Chapter 1" required>
                                </div>
                                
                                <div>
                                    <p class="block text-sm font-medium text-slate-700">3. Add Questions</p>
                                    <ul id="admin-question-list" class="mt-2 space-y-1 list-disc list-inside bg-slate-50 p-3 rounded-md min-h-[50px]">
                                        <!-- New questions will be listed here -->
                                    </ul>
                                    <button id="add-question-button" type="button" class="mt-2 px-4 py-2 bg-blue-500 text-white text-sm rounded-md hover:bg-blue-600">
                                        + Add Question
                                    </button>
                                </div>
                                
                                <hr class="my-4">

                                <button id="save-chapter-button" type="button" class="w-full px-5 py-3 bg-green-600 text-white font-semibold rounded-md hover:bg-green-700 disabled:bg-slate-400">
                                    4. Save New Chapter to Database
                                </button>
                                <p id="create-chapter-message" class="text-sm mt-2"></p>
                            </div>
                        </div>
                    </div>
                </details>
            </div>

            <!-- "Add Question" Modal (hidden by default) -->
            <div id="new-question-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
                <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg space-y-4">
                    <h3 class="text-lg font-semibold">Add New Question</h3>
                    
                    <div>
                        <label for="question-text-input" class="block text-sm font-medium text-slate-700">Question Text</label>
                        <textarea id="question-text-input" rows="3" class="mt-1 w-full p-2 border border-slate-300 rounded-md"></textarea>
                    </div>
                    
                    <div>
                        <label for="question-type-select" class="block text-sm font-medium text-slate-700">Question Type</label>
                        <select id="question-type-select" class="mt-1 w-full p-2 border border-slate-300 rounded-md">
                            <option value="mcq">Multiple Choice</option>
                            <option value="short_answer">Short Answer</option>
                        </select>
                    </div>

                    <!-- MCQ Options -->
                    <div id="mcq-options-container" class="space-y-3">
                        <label class="block text-sm font-medium text-slate-700">Options</label>
                        <div id="mcq-option-inputs" class="space-y-2">
                            <!-- JS will add inputs here -->
                        </div>
                        <button id="add-option-button" type="button" class="text-sm text-blue-600 hover:text-blue-800">+ Add another option</button>
                        
                        <div>
                            <label for="mcq-correct-answer-select" class="block text-sm font-medium text-slate-700">Correct Answer</label>
                            <select id="mcq-correct-answer-select" class="mt-1 w-full p-2 border border-slate-300 rounded-md">
                                <!-- JS will add options here -->
                            </select>
                        </div>
                    </div>

                    <!-- Short Answer Options -->
                    <div id="short-answer-container" class="hidden space-y-3">
                        <label for="short-answer-input" class="block text-sm font-medium text-slate-700">Model Answer</label>
                        <textarea id="short-answer-input" rows="2" class="mt-1 w-full p-2 border border-slate-300 rounded-md" placeholder="Type the suggested answer..."></textarea>
                    </div>
                    
                    <!-- Modal Controls -->
                    <div class="flex justify-end gap-3 mt-6">
                        <button id="cancel-question-button" type="button" class="px-4 py-2 bg-slate-200 text-slate-800 rounded-md hover:bg-slate-300">Cancel</button>
                        <button id="save-question-button" type="button" class="px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600">Save Question</button>
                    </div>
                </div>
            </div>

            <!-- Book Selection -->
            <div class="p-6 border-b border-slate-200">
                <h2 class="text-2xl font-semibold text-slate-800">Select a Book</h2>
                <div id="book-list" class="mt-4 space-y-3">
                    <!-- Books will be loaded here -->
                </div>
            </div>

            <!-- Chapter & Quiz Content -->
            <div class="p-6">
                <h2 id="section-title" class="text-2xl font-semibold text-slate-800">Select a Book to See Chapters</h2>
                
                <!-- Tab Navigation -->
                <div class="border-b border-slate-200 mt-4">
                    <nav id="chapter-tabs" class="flex overflow-x-auto tab-scroll -mb-px px-4" aria-label="Tabs">
                        <!-- Chapter tabs will be loaded here -->
                    </nav>
                </div>

                <!-- Quiz Content -->
                <div id="quiz-container" class="mt-6">
                    <!-- Quiz questions will be loaded here -->
                </div>
            </div>
        </div>
    </div>

</body>
</html>
